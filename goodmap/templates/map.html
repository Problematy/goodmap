{% extends "base.html" %}

{% block left_panel %}
<div id="filter-form"></div>
{% endblock %}

{% block content %}

    <style>
        .loading-popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            align-items: center;
            justify-content: center;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            font-size: 24px;
            z-index: 1000;
        }
    </style>

<div id="loadingPopup" class="loading-popup">
    Loading...
</div>

<div id="map" class="map h-100 w-100"></div>


<script type="text/javascript">

(function() {
    console.log("Interceptor script loaded");

    // Intercept XMLHttpRequest
    const originalOpen = XMLHttpRequest.prototype.open;
    const originalSend = XMLHttpRequest.prototype.send;

    XMLHttpRequest.prototype.open = function(method, url) {
        console.log("XMLHttpRequest open", url);
        if (url.includes('/api/data')) {  // Adjust this condition to match your API endpoint
            this.addEventListener('loadstart', showLoading);
            this.addEventListener('loadend', hideLoading);
        }
        return originalOpen.apply(this, arguments);
    };

    XMLHttpRequest.prototype.send = function() {
        console.log("XMLHttpRequest send");
        return originalSend.apply(this, arguments);
    };

    // Intercept fetch
    const originalFetch = window.fetch;

    window.fetch = async function(url, options) {
        console.log("fetch", url);
        if (url.includes('/api/data')) {  // Adjust this condition to match your API endpoint
            showLoading();
        }
        try {
            const response = await originalFetch(url, options);
            return response;
        } catch (error) {
            throw error;
        } finally {
            if (url.includes('/api/data')) {
                hideLoading();
            }
        }
    };

    let loadingTimeout;

    function showLoading() {
        clearTimeout(loadingTimeout);
        loadingTimeout = setTimeout(() => {
            const loadingPopup = document.getElementById('loadingPopup');
            if (loadingPopup) {
                loadingPopup.style.display = 'flex';
            }
        }, 100); // Adjust the delay as needed
    }

    function hideLoading() {
        clearTimeout(loadingTimeout);
        const loadingPopup = document.getElementById('loadingPopup');
        if (loadingPopup) {
            loadingPopup.style.display = 'none';
        }
    }
})();

</script>
<script src="/static/map.js"></script>
{% endblock %}
